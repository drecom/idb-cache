// idb-cache - https://github.com/drecom/idb-cache
var IDBCache=function(){"use strict";function t(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}var _="metastore",h="datastore",r=1,a=2,i=3,l=/iP(hone|(o|a)d);/.test(window.navigator.userAgent),e=function(){function d(e,n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,d),this._maxSize=52428800,this._maxCount=100,this._defaultAge=86400,this._nowSize=0,this._metaCache=new Map,this._indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,this._dbName=e,this._indexedDB?(n&&(n.size&&(this._maxSize=n.size),n.count&&(this._maxCount=n.count),n.defaultAge&&(this._defaultAge=n.defaultAge)),this._initialization=this._initialize()):console.error("IndexedDB is not supported")}var e,n,o;return e=d,(n=[{key:"set",value:function(c,e){var s=this,f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this._defaultAge;return new Promise(function(l,u){s._serializeData(e,function(a,i){0!==i.size?s._open(function(e){var n=e.transaction([_,h],"readwrite"),o=n.objectStore(_),t=n.objectStore(h),r=Math.floor(Date.now()/1e3);i.expire=r+f,n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null;var e=s._metaCache.get(c);e&&(s._metaCache.delete(c),s._nowSize-=e.size),s._metaCache.set(c,i),s._nowSize+=i.size,(s._maxCount<s._metaCache.size||s._maxSize<s._nowSize)&&s._cleanup(),l()},n.onerror=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,u(d.ERROR.REQUEST_FAILED)},n.onabort=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,u(d.ERROR.REQUEST_FAILED)};try{t.put(a,c),o.put(i,c)}catch(e){console.error(e),n.abort()}},function(e){u(e)}):u(d.ERROR.INVALID_ARGUMENT)})})}},{key:"get",value:function(a){var i=this;return new Promise(function(t,r){i._open(function(e){var o=e.transaction(h,"readonly").objectStore(h).get(a);o.onsuccess=function(){o.onsuccess=null,o.onerror=null;var e=Math.floor(Date.now()/1e3),n=i._metaCache.get(a);o.result&&n&&e<n.expire?i._deserializeData(o.result,n,function(e){t(e)}):r(d.ERROR.GET_EMPTY)},o.onerror=function(){o.onsuccess=null,o.onerror=null,r(d.ERROR.REQUEST_FAILED)}},function(e){r(e)})})}},{key:"has",value:function(o){var t=this;return this._initialization?this._initialization.then(function(){var e=t._metaCache.get(o),n=Math.floor(Date.now()/1e3);return Boolean(e&&n<e.expire)}):Promise.reject(d.ERROR.NOT_SUPPORT_IDB)}},{key:"delete",value:function(i){var l=this;return new Promise(function(r,a){l._open(function(e){var n=e.transaction([_,h],"readwrite"),o=n.objectStore(_),t=n.objectStore(h);n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null;var e=l._metaCache.get(i);e&&(l._metaCache.delete(i),l._nowSize-=e.size),r()},n.onerror=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,a(d.ERROR.REQUEST_FAILED)},n.onabort=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,a(d.ERROR.REQUEST_FAILED)};try{t.delete(i),o.delete(i)}catch(e){console.error(e),n.abort()}},function(e){a(e)})})}},{key:"_initialize",value:function(){var f=this;return new Promise(function(s){f._open(function(e){var i=e.transaction(_,"readonly"),n=i.objectStore(_);f._metaCache.clear(),f._nowSize=0;var l,u,c=!1;n.getAllKeys&&n.getAll?c=!0:console.warn("This device does not support getAll"),i.oncomplete=function(){if(i.oncomplete=null,i.onerror=null,c)for(var e=0;e<l.length;e++){var n=l[e],o=u[e];f._metaCache.set(n,o),f._nowSize+=o.size}for(var t=[],r=f._metaCache.entries(),a=r.next();!a.done;)t.push(a.value),a=r.next();t.sort(function(e,n){return e[1].expire<n[1].expire?-1:e[1].expire>n[1].expire?1:0}),f._metaCache=new Map(t),f._cleanup(),s()},i.onerror=function(){i.oncomplete=null,i.onerror=null,s()},c?(n.getAllKeys().onsuccess=function(e){l=e.target.result},n.getAll().onsuccess=function(e){u=e.target.result}):n.openCursor().onsuccess=function(e){var n=e.target.result;n&&(f._metaCache.set(n.key,n.value),f._nowSize+=n.value.size,n.continue())}},function(){})})}},{key:"_cleanup",value:function(){var l=this;this._open(function(e){var o=new Set,t=Math.floor(Date.now()/1e3),r=l._metaCache.size;if(l._metaCache.forEach(function(e,n){(e.expire<t||l._maxSize<l._nowSize||l._maxCount<r)&&(o.add(n),l._nowSize-=e.size,r--)}),0<o.size){var n=e.transaction([_,h],"readwrite"),a=n.objectStore(_),i=n.objectStore(h);n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,o.forEach(function(e){l._metaCache.has(e)&&l._metaCache.delete(e)})},n.onerror=function(){console.error("IndexedDB cleanup failed"),n.oncomplete=null,n.onerror=null,n.onabort=null,l._nowSize=0,l._metaCache.forEach(function(e){l._nowSize+=e.size})},n.onabort=function(){console.error("IndexedDB cleanup failed"),n.oncomplete=null,n.onerror=null,n.onabort=null,l._nowSize=0,l._metaCache.forEach(function(e){l._nowSize+=e.size})},o.forEach(function(e){try{i.delete(e),a.delete(e)}catch(e){n.abort()}})}},function(){})}},{key:"_createObjectStore",value:function(e,n){n<1&&(e.createObjectStore(_),e.createObjectStore(h))}},{key:"_open",value:function(e,n){var o=this;if(this._indexedDB){var t=this._indexedDB.open(this._dbName,1);t.onupgradeneeded=function(e){t.onupgradeneeded=null,o._createObjectStore(t.result,e.oldVersion)},t.onblocked=function(){t.onblocked=null,alert("Please close other tabs")},t.onsuccess=function(){t.onupgradeneeded=null,t.onblocked=null,t.onsuccess=null,t.onerror=null;try{e(t.result)}catch(e){console.error(e),n(d.ERROR.UNKNOWN)}},t.onerror=function(){console.error("IndexedDB open failed"),t.onupgradeneeded=null,t.onblocked=null,t.onsuccess=null,t.onerror=null,n(d.ERROR.CANNOT_OPEN)}}else n(d.ERROR.NOT_SUPPORT_IDB)}},{key:"_serializeData",value:function(e,n){var o={type:0,size:0};if("string"==typeof e?(o.type=r,o.size=e.length):e instanceof ArrayBuffer?(o.type=a,o.size=e.byteLength):e instanceof Blob?(o.type=i,o.size=e.size):console.warn("Is not supported type of value"),l&&o.type===i){var t=new FileReader;t.onload=function(){t.onload=null,o.size=t.result.byteLength,o.mime=e.type,n(t.result,o)},t.onerror=function(){t.onerror=null,o.size=0,n(null,o)},t.readAsArrayBuffer(e)}else n(e,o)}},{key:"_deserializeData",value:function(e,n,o){var t=0;("string"==typeof e?t=r:e instanceof ArrayBuffer?t=a:e instanceof Blob&&(t=i),n&&n.type===i&&t===a)?o(new Blob([e],{type:n.mime})):o(e)}}])&&t(e.prototype,n),o&&t(e,o),d}();return e.ERROR={INVALID_ARGUMENT:1,CANNOT_OPEN:2,REQUEST_FAILED:3,GET_EMPTY:4,NOT_SUPPORT_IDB:5,UNKNOWN:6},e}();