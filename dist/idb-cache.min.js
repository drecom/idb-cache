// idb-cache - https://github.com/drecom/idb-cache
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.IDBCache=n()}(this,function(){"use strict";var o=function(e,n){var o="function"==typeof Symbol&&e[Symbol.iterator];if(!o)return e;var t,r,i=o.call(e),l=[];try{for(;(void 0===n||0<n--)&&!(t=i.next()).done;)l.push(t.value)}catch(e){r={error:e}}finally{try{t&&!t.done&&(o=i.return)&&o.call(i)}finally{if(r)throw r.error}}return l},r=function(){for(var e=[],n=0;n<arguments.length;n++)e=e.concat(o(arguments[n]));return e},p="metastore",_="datastore",i=1,l=2,a=3,c=/iP(hone|(o|a)d);/.test(window.navigator.userAgent);return function(){function d(e,n){this._maxSize=52428800,this._maxCount=100,this._defaultAge=86400,this._nowSize=0,this._metaCache=new Map,this._indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,this._dbName=e,this._indexedDB?(n&&(n.size&&(this._maxSize=n.size),n.count&&(this._maxCount=n.count),n.defaultAge&&(this._defaultAge=n.defaultAge)),this._initialize()):console.error("IndexedDB is not supported")}return d.prototype.set=function(u,e,s){var f=this;return void 0===s&&(s=this._defaultAge),new Promise(function(a,c){f._serializeData(e,function(i,l){0!==l.size?f._open(function(e){var n=e.transaction([p,_],"readwrite"),o=n.objectStore(p),t=n.objectStore(_),r=Math.floor(Date.now()/1e3);l.expire=r+s,n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null;var e=f._metaCache.get(u);e&&(f._metaCache.delete(u),f._nowSize-=e.size),f._metaCache.set(u,l),f._nowSize+=l.size,(f._maxCount<f._metaCache.size||f._maxSize<f._nowSize)&&f._cleanup(),a()},n.onerror=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,c(d.ERROR.REQUEST_FAILED)},n.onabort=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,c(d.ERROR.REQUEST_FAILED)};try{t.put(i,u),o.put(l,u)}catch(e){console.error(e),n.abort()}},function(){c(d.ERROR.CANNOT_OPEN)}):c(d.ERROR.INVALID_ARGUMENT)})})},d.prototype.get=function(i){var l=this;return new Promise(function(t,r){l._open(function(e){var o=e.transaction(_,"readonly").objectStore(_).get(i);o.onsuccess=function(){o.onsuccess=null,o.onerror=null;var e=Math.floor(Date.now()/1e3),n=l._metaCache.get(i);o.result&&n&&e<n.expire?l._deserializeData(o.result,n,function(e){t(e)}):r(d.ERROR.GET_EMPTY)},o.onerror=function(){o.onsuccess=null,o.onerror=null,r(d.ERROR.REQUEST_FAILED)}},function(){r(d.ERROR.CANNOT_OPEN)})})},d.prototype.delete=function(l){var a=this;return new Promise(function(r,i){a._open(function(e){var n=e.transaction([p,_],"readwrite"),o=n.objectStore(p),t=n.objectStore(_);n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null;var e=a._metaCache.get(l);e&&(a._metaCache.delete(l),a._nowSize-=e.size),r()},n.onerror=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,i(d.ERROR.REQUEST_FAILED)},n.onabort=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,i(d.ERROR.REQUEST_FAILED)};try{t.delete(l),o.delete(l)}catch(e){console.error(e),n.abort()}},function(){i(d.ERROR.CANNOT_OPEN)})})},d.prototype._initialize=function(){var t=this;this._open(function(e){var n=e.transaction(p,"readonly"),o=n.objectStore(p);t._metaCache.clear(),t._nowSize=0,n.oncomplete=function(){n.oncomplete=null,n.onerror=null,t._metaCache=new Map(r(t._metaCache.entries()).sort(function(e,n){return e[1].expire<n[1].expire?-1:e[1].expire>n[1].expire?1:0})),t._cleanup()},n.onerror=function(){n.oncomplete=null,n.onerror=null},o.openCursor().onsuccess=function(e){var n=e.target.result;n&&(t._metaCache.set(n.key,n.value),t._nowSize+=n.value.size,n.continue())}},function(){})},d.prototype._cleanup=function(){var a=this;this._open(function(e){var o=new Set,t=Math.floor(Date.now()/1e3),r=a._metaCache.size;if(a._metaCache.forEach(function(e,n){(e.expire<t||a._maxSize<a._nowSize||a._maxCount<r)&&(o.add(n),a._nowSize-=e.size,r--)}),0<o.size){var n=e.transaction([p,_],"readwrite"),i=n.objectStore(p),l=n.objectStore(_);n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,o.forEach(function(e){a._metaCache.has(e)&&a._metaCache.delete(e)})},n.onerror=function(){console.error("IndexedDB cleanup failed"),n.oncomplete=null,n.onerror=null,n.onabort=null,a._nowSize=0,a._metaCache.forEach(function(e){a._nowSize+=e.size})},n.onabort=function(){console.error("IndexedDB cleanup failed"),n.oncomplete=null,n.onerror=null,n.onabort=null,a._nowSize=0,a._metaCache.forEach(function(e){a._nowSize+=e.size})},o.forEach(function(e){try{l.delete(e),i.delete(e)}catch(e){n.abort()}})}},function(){})},d.prototype._createObjectStore=function(e,n){n<1&&(e.createObjectStore(p),e.createObjectStore(_))},d.prototype._open=function(e,n){var o=this;if(this._indexedDB){var t=this._indexedDB.open(this._dbName,1);t.onupgradeneeded=function(e){t.onupgradeneeded=null,o._createObjectStore(t.result,e.oldVersion)},t.onblocked=function(){t.onblocked=null,alert("Please close other tabs")},t.onsuccess=function(){t.onupgradeneeded=null,t.onblocked=null,t.onsuccess=null,t.onerror=null,e(t.result)},t.onerror=function(){console.error("IndexedDB open failed"),t.onupgradeneeded=null,t.onblocked=null,t.onsuccess=null,t.onerror=null,n()}}else n()},d.prototype._serializeData=function(e,n){var o={type:0,size:0};if("string"==typeof e?(o.type=i,o.size=e.length):e instanceof ArrayBuffer?(o.type=l,o.size=e.byteLength):e instanceof Blob?(o.type=a,o.size=e.size):console.warn("Is not supported type of value"),c&&o.type===a){var t=new FileReader;t.onload=function(){t.onload=null,o.size=t.result.byteLength,o.mime=e.type,n(t.result,o)},t.onerror=function(){t.onerror=null,o.size=0,n(null,o)},t.readAsArrayBuffer(e)}else n(e,o)},d.prototype._deserializeData=function(e,n,o){var t=0;("string"==typeof e?t=i:e instanceof ArrayBuffer?t=l:e instanceof Blob&&(t=a),n&&n.type===a&&t===l)?o(new Blob([e],{type:n.mime})):o(e)},d.ERROR={INVALID_ARGUMENT:1,CANNOT_OPEN:2,REQUEST_FAILED:3,GET_EMPTY:4},d}()});