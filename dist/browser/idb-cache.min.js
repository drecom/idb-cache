// idb-cache - https://github.com/drecom/idb-cache
var IDBCache=function(){"use strict";function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function o(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function e(e,n,t){return n&&o(e.prototype,n),t&&o(e,t),e}function c(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=[],o=!0,r=!1,i=void 0;try{for(var l,a=e[Symbol.iterator]();!(o=(l=a.next()).done)&&(t.push(l.value),!n||t.length!==n);o=!0);}catch(e){r=!0,i=e}finally{try{o||null==a.return||a.return()}finally{if(r)throw i}}return t}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var i=function(){function o(e,n,t){r(this,o),this._id=e,this._key=n,this._length=t}return e(o,[{key:"length",get:function(){return this._length}},{key:"key",get:function(){return this._key}},{key:"id",get:function(){return this._id}}]),o}(),_="metastore",h="datastore",l=1,a=2,u=3,s=4,f=function(){var e=navigator.userAgent;if(/iP(hone|(o|a)d)/.test(e)){var n=/ip[honead]{2,4}(?:.*os\s(\w+)\slike\smac)/i.exec(e);if(n){var t=c(n[1].split("_"),3),o=t[0],r=void 0===o?"":o,i=t[1],l=void 0===i?"":i,a=t[2],u=void 0===a?"":a;if(("000"+r).slice(-3)+("000"+l).slice(-3)+("000"+u).slice(-3)<"012002000")return!1}}return!0}(),n=function(){function d(e,n){r(this,d),this._maxSize=52428800,this._maxCount=100,this._defaultAge=86400,this._nowSize=0,this._metaCache=new Map,this._indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,this._dbName=e,this._indexedDB?(n&&(n.size&&(this._maxSize=n.size),n.count&&(this._maxCount=n.count),n.defaultAge&&(this._defaultAge=n.defaultAge)),this._initialize()):console.error("IndexedDB is not supported")}return e(d,[{key:"set",value:function(c,e,n){var s=this,f=2<arguments.length&&void 0!==n?n:this._defaultAge;return new Promise(function(a,u){s._serializeData(e,function(i,l){0!==l.size?s._open(function(e){var n=e.transaction([_,h],"readwrite"),t=n.objectStore(_),o=n.objectStore(h),r=Math.floor(Date.now()/1e3);l.expire=r+f,n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null;var e=s._metaCache.get(c);e&&(s._metaCache.delete(c),s._nowSize-=e.size),s._metaCache.set(c,l),s._nowSize+=l.size,(s._maxCount<s._metaCache.size||s._maxSize<s._nowSize)&&s._cleanup(),a()},n.onerror=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,u(d.ERROR.REQUEST_FAILED)},n.onabort=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,u(d.ERROR.REQUEST_FAILED)};try{o.put(i,c),t.put(l,c)}catch(e){console.error(e),n.abort()}},function(e){u(e)}):u(d.ERROR.INVALID_ARGUMENT)})})}},{key:"get",value:function(i){var l=this;return new Promise(function(o,r){l._open(function(e){var t=e.transaction(h,"readonly").objectStore(h).get(i);t.onsuccess=function(){t.onsuccess=null,t.onerror=null;var e=Math.floor(Date.now()/1e3),n=l._metaCache.get(i);t.result&&n&&e<n.expire?l._deserializeData(t.result,n,function(e){o(e)}):r(d.ERROR.GET_EMPTY)},t.onerror=function(){t.onsuccess=null,t.onerror=null,r(d.ERROR.REQUEST_FAILED)}},function(e){r(e)})})}},{key:"delete",value:function(l){var a=this;return new Promise(function(r,i){a._open(function(e){var n=e.transaction([_,h],"readwrite"),t=n.objectStore(_),o=n.objectStore(h);n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null;var e=a._metaCache.get(l);e&&(a._metaCache.delete(l),a._nowSize-=e.size),r()},n.onerror=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,i(d.ERROR.REQUEST_FAILED)},n.onabort=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,i(d.ERROR.REQUEST_FAILED)};try{o.delete(l),t.delete(l)}catch(e){console.error(e),n.abort()}},function(e){i(e)})})}},{key:"_initialize",value:function(){var s=this;this._open(function(e){var l=e.transaction(_,"readonly"),n=l.objectStore(_);s._metaCache.clear(),s._nowSize=0;var a,u,c=!1;n.getAllKeys&&n.getAll?c=!0:console.warn("This device does not support getAll"),l.oncomplete=function(){if(l.oncomplete=null,l.onerror=null,c)for(var e=0;e<a.length;e++){var n=a[e],t=u[e];s._metaCache.set(n,t),s._nowSize+=t.size}for(var o=[],r=s._metaCache.entries(),i=r.next();!i.done;)o.push(i.value),i=r.next();o.sort(function(e,n){return e[1].expire<n[1].expire?-1:e[1].expire>n[1].expire?1:0}),s._metaCache=new Map(o),s._cleanup()},l.onerror=function(){l.oncomplete=null,l.onerror=null},c?(n.getAllKeys().onsuccess=function(e){a=e.target.result},n.getAll().onsuccess=function(e){u=e.target.result}):n.openCursor().onsuccess=function(e){var n=e.target.result;n&&(s._metaCache.set(n.key,n.value),s._nowSize+=n.value.size,n.continue())}},function(){})}},{key:"_cleanup",value:function(){var a=this;this._open(function(e){var t=new Set,o=Math.floor(Date.now()/1e3),r=a._metaCache.size;if(a._metaCache.forEach(function(e,n){(e.expire<o||a._maxSize<a._nowSize||a._maxCount<r)&&(t.add(n),a._nowSize-=e.size,r--)}),0<t.size){var n=e.transaction([_,h],"readwrite"),i=n.objectStore(_),l=n.objectStore(h);n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,t.forEach(function(e){a._metaCache.has(e)&&a._metaCache.delete(e)})},n.onerror=function(){console.error("IndexedDB cleanup failed"),n.oncomplete=null,n.onerror=null,n.onabort=null,a._nowSize=0,a._metaCache.forEach(function(e){a._nowSize+=e.size})},n.onabort=function(){console.error("IndexedDB cleanup failed"),n.oncomplete=null,n.onerror=null,n.onabort=null,a._nowSize=0,a._metaCache.forEach(function(e){a._nowSize+=e.size})},t.forEach(function(e){try{l.delete(e),i.delete(e)}catch(e){n.abort()}})}},function(){})}},{key:"_createObjectStore",value:function(e,n){n<1&&(e.createObjectStore(_),e.createObjectStore(h))}},{key:"_open",value:function(e,n){var t=this;if(this._indexedDB){var o=this._indexedDB.open(this._dbName,1);o.onupgradeneeded=function(e){o.onupgradeneeded=null,t._createObjectStore(o.result,e.oldVersion)},o.onblocked=function(){o.onblocked=null,alert("Please close other tabs")},o.onsuccess=function(){o.onupgradeneeded=null,o.onblocked=null,o.onsuccess=null,o.onerror=null;try{e(o.result)}catch(e){console.error(e),n(d.ERROR.UNKNOWN)}},o.onerror=function(){console.error("IndexedDB open failed"),o.onupgradeneeded=null,o.onblocked=null,o.onsuccess=null,o.onerror=null,n(d.ERROR.CANNOT_OPEN)}}else n(d.ERROR.NOT_SUPPORT_IDB)}},{key:"_serializeData",value:function(e,n){var t={type:0,size:0};if("string"==typeof e?(t.type=l,t.size=e.length):e instanceof ArrayBuffer?(t.type=a,t.size=e.byteLength):e instanceof Blob?(t.type=u,t.size=e.size):e instanceof i?(t.type=s,t.size=e.length):console.warn("Is not supported type of value"),f||t.type!==u)n(e,t);else{var o=new FileReader;o.onload=function(){o.onload=null,t.size=o.result.byteLength,t.mime=e.type,n(o.result,t)},o.onerror=function(){o.onerror=null,t.size=0,n(null,t)},o.readAsArrayBuffer(e)}}},{key:"_deserializeData",value:function(e,n,t){var o=0;("string"==typeof e?o=l:e instanceof ArrayBuffer?o=a:e instanceof Blob?o=u:e instanceof i&&(o=s),n&&n.type===u&&o===a)?t(new Blob([e],{type:n.mime})):t(e)}}]),d}();return n.ERROR={INVALID_ARGUMENT:1,CANNOT_OPEN:2,REQUEST_FAILED:3,GET_EMPTY:4,NOT_SUPPORT_IDB:5,UNKNOWN:6},n}();